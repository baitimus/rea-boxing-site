name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  REGISTRY_URL: 192.168.1.6:5000
  PROJECT_NAME: rea-boxing-site

jobs:
  build-and-push:
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Login to private registry
      run: |
        echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY_URL }} -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin
        echo "âœ… Logged in to registry"

    - name: Set image tags
      id: tags
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "BACKEND_IMAGE=${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}-backend:latest" >> $GITHUB_OUTPUT
        echo "FRONTEND_IMAGE=${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}-frontend:latest" >> $GITHUB_OUTPUT
        echo "BACKEND_IMAGE_SHA=${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}-backend:$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "FRONTEND_IMAGE_SHA=${{ env.REGISTRY_URL }}/${{ env.PROJECT_NAME }}-frontend:$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_OUTPUT

    - name: Build backend image
      run: |
        echo "ðŸ”¨ Building backend image..."
        docker build \
          -f src/backend/Dockerfile.prod \
          -t ${{ steps.tags.outputs.BACKEND_IMAGE }} \
          -t ${{ steps.tags.outputs.BACKEND_IMAGE_SHA }} \
          src/backend
        echo "âœ… Backend image built"

    - name: Build frontend image
      run: |
        echo "ðŸ”¨ Building frontend image..."
        docker build \
          -f src/frontend/Dockerfile.prod \
          -t ${{ steps.tags.outputs.FRONTEND_IMAGE }} \
          -t ${{ steps.tags.outputs.FRONTEND_IMAGE_SHA }} \
          src/frontend
        echo "âœ… Frontend image built"

    - name: Push images to registry
      run: |
        echo "ðŸ“¤ Pushing backend images..."
        docker push ${{ steps.tags.outputs.BACKEND_IMAGE }}
        docker push ${{ steps.tags.outputs.BACKEND_IMAGE_SHA }}
        
        echo "ðŸ“¤ Pushing frontend images..."
        docker push ${{ steps.tags.outputs.FRONTEND_IMAGE }}
        docker push ${{ steps.tags.outputs.FRONTEND_IMAGE_SHA }}
        
        echo "âœ… All images pushed successfully!"

    - name: Verify images in registry
      run: |
        echo "ðŸ” Verifying images in registry..."
        curl -u ${{ secrets.REGISTRY_USERNAME }}:${{ secrets.REGISTRY_PASSWORD }} \
          http://${{ env.REGISTRY_URL }}/v2/_catalog

    - name: Clean up local images
      run: |
        docker image prune -f
        echo "ðŸ§¹ Cleanup completed"

    - name: Logout from registry
      if: always()
      run: docker logout ${{ env.REGISTRY_URL }}

    - name: Build summary
      run: |
        echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Images pushed:" >> $GITHUB_STEP_SUMMARY
        echo "- Backend: \`${{ steps.tags.outputs.BACKEND_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend: \`${{ steps.tags.outputs.FRONTEND_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### SHA: \`${{ steps.tags.outputs.SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    
    steps:
    - name: Trigger deployment webhook
      run: |
        echo "ðŸš€ Triggering deployment on ${{ secrets.DEPLOYMENT_HOST }}..."
        
          response=$(curl -X POST \
            -H "X-Webhook-Secret: ${{ secrets.WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s \
            http://${{ secrets.DEPLOYMENT_HOST }}:9000/hooks/deploy-rea-boxing-site)
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | head -n-1)
        
        echo "HTTP Status: $http_code"
        echo "Response: $body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "âœ… Deployment triggered successfully!"
        else
          echo "âŒ Webhook failed with status $http_code"
          exit 1
        fi

    - name: Wait for deployment
      run: |
        echo "â³ Waiting 60 seconds for deployment to complete..."
        sleep 60

    - name: Verify deployment
      run: |
        echo "ðŸ” Checking deployment health..."
        
        if curl -f -m 10 http://${{ secrets.DEPLOYMENT_HOST }}:80 >/dev/null 2>&1; then
          echo "âœ… Frontend is responding"
        else
          echo "âŒ Frontend is not responding"
        fi
        
        if curl -f -m 10 http://${{ secrets.DEPLOYMENT_HOST }}:3000 >/dev/null 2>&1; then
          echo "âœ… Backend is responding"
        else
          echo "âš ï¸  Backend is not responding"
        fi

    - name: Deployment summary
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access your application:" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: http://${{ secrets.DEPLOYMENT_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: http://${{ secrets.DEPLOYMENT_HOST }}:3000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Monitor deployment:" >> $GITHUB_STEP_SUMMARY
          echo "```bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh root@${{ secrets.DEPLOYMENT_HOST }} 'cd /root/deployments/rea-boxing-site && ./logs.sh'" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY