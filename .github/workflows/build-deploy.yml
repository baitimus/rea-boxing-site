name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Stop existing containers
      run: |
        cd ~/deployments/rea-boxing-site || true
        docker compose -f docker-compose.prod.yml down || true

    - name: Create deployment directory
      run: |
        mkdir -p ~/deployments/rea-boxing-site
        cp docker-compose.prod.yml ~/deployments/rea-boxing-site/
        cp .env.production ~/deployments/rea-boxing-site/
        cp -r src ~/deployments/rea-boxing-site/

    - name: Build and start containers
      run: |
        cd ~/deployments/rea-boxing-site
        docker compose --env-file .env.production -f docker-compose.prod.yml build --no-cache
        docker compose --env-file .env.production -f docker-compose.prod.yml up -d --force-recreate

    - name: Wait for services to be healthy
      run: |
        cd ~/deployments/rea-boxing-site
        echo "Waiting for services to start..."
        sleep 30
        
        # Check if MongoDB is healthy
        for i in {1..30}; do
          if docker compose --env-file .env.production -f docker-compose.prod.yml ps | grep -q "mongodb.*healthy"; then
            echo "âœ… MongoDB is healthy"
            break
          fi
          echo "Waiting for MongoDB... (attempt $i/30)"
          sleep 10
          if [ $i -eq 30 ]; then
            echo "âŒ MongoDB failed to start"
            exit 1
          fi
        done
        
        # Check if backend is responding
        for i in {1..30}; do
          if curl -f http://localhost:3000 >/dev/null 2>&1; then
            echo "âœ… Backend is responding"
            break
          fi
          echo "Waiting for backend... (attempt $i/30)"
          sleep 10
          if [ $i -eq 30 ]; then
            echo "âŒ Backend failed to start"
            exit 1
          fi
        done
        
        # Check if frontend is responding
        for i in {1..30}; do
          if curl -f http://localhost:8080 >/dev/null 2>&1; then
            echo "âœ… Frontend is responding"
            break
          fi
          echo "Waiting for frontend... (attempt $i/30)"
          sleep 10
          if [ $i -eq 30 ]; then
            echo "âŒ Frontend failed to start"
            exit 1
          fi
        done

    - name: Show deployment status
      run: |
        cd ~/deployments/rea-boxing-site
        echo "ğŸ‰ Deployment successful!"
        echo ""
        echo "ğŸ“Š Container Status:"
        docker compose --env-file .env.production -f docker-compose.prod.yml ps
        echo ""
        echo "ğŸŒ Service URLs:"
        echo "  Frontend: http://localhost:8080"
        echo "  Backend API: http://localhost:3000"
        echo "  MongoDB: Internal only"

    - name: Clean up old images
      run: |
        # Remove dangling images to save space
        docker image prune -f || true
        echo "âœ… Cleanup completed"

    - name: Send notification
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        cd ~/deployments/rea-boxing-site
        echo "ğŸ“‹ Container logs:"
        docker compose --env-file .env.production -f docker-compose.prod.yml logs --tail=50
